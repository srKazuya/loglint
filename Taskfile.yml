version: '3'

vars:
  GOLANGCI_LINT_VERSION: 'v2.1.5'

  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  ROOT_DIR: .
  BIN_DIR: '{{.ROOT_DIR}}/bin'

tasks:
  test:
    cmds:
      - go test -v ./...

  build:
    cmds:
      - go build -o {{.BIN_DIR}}/loglint.exe cmd/loglint/main.go

  run:
    deps:
      - build
      - test
    cmds:
      - '{{.BIN_DIR}}/loglint {{.ROOT_DIR}}/testdata/englishonly.go'

  lint-with-standalone:
      deps: [build]
      cmds:
        - for f in ./testdata/**/*.go; do ./bin/loglint "$f" || true; done
  
  lint-with-standalone-fix:
      deps: [build]
      cmds:
        - for f in ./testdata/**/*.go; do ./bin/loglint --fix "$f" || true; echo file fixed; done

  install-golangci-lint:
    desc: "Устанавливает golangci-lint в каталог bin"
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        echo "Устанавливаем golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
        GOBIN="$(pwd)/bin" go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
    status:
      - test -x {{.BIN_DIR}}/golangci-lint

  make-plugin:
    desc: "Собираем плагины для golangci-lint"
    deps: [ install-golangci-lint ]
    cmds:
      - '{{.BIN_DIR}}/golangci-lint custom'

  lint-with-plugin:
    desc: "Запускаем golangci-lint для всех модулей"
    deps: 
      - make-plugin
    cmds:
      - |
        echo "Линтим с помощью плагина custom-gcl.exe"
        ./custom-gcl run ./...
